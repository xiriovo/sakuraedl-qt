#pragma once

#include <QByteArray>
#include <QObject>
#include <QString>
#include <cstdint>
#include <functional>

namespace sakura {

class ITransport;
struct SaharaDeviceInfo;

// ─── PBL exploit types ──────────────────────────────────────────────
enum class PblExploitType {
    None = 0,
    Firehose,           // Force-enter Firehose without signed loader
    MemoryDump,         // Dump PBL/SBL memory
    AuthBypass,         // Bypass signature verification
};

// ─── PBL exploit result ──────────────────────────────────────────────
struct PblExploitResult {
    bool success = false;
    PblExploitType type = PblExploitType::None;
    QByteArray data;            // Result data (memory dump, etc.)
    QString message;
};

// ─── PBL exploit interface ───────────────────────────────────────────
// Placeholder for PBL (Primary Boot Loader) exploits.
// These are hardware-level vulnerabilities in the Qualcomm boot ROM
// that can be used to bypass secure boot.
//
// DISCLAIMER: This is for research and legitimate device recovery only.
class PblExploit : public QObject {
    Q_OBJECT

public:
    explicit PblExploit(ITransport* transport, QObject* parent = nullptr);

    // Check if the device's PBL is vulnerable
    bool isVulnerable(const SaharaDeviceInfo& deviceInfo) const;

    // Attempt to exploit the PBL to enter unrestricted Firehose mode
    PblExploitResult exploit(const SaharaDeviceInfo& deviceInfo);

    // Dump PBL memory (if exploit is available)
    QByteArray dumpPblMemory(uint64_t address, uint32_t size);

    // Dump SBL memory region
    QByteArray dumpSblMemory(uint64_t address, uint32_t size);

    // Get list of vulnerable chip IDs
    static QList<uint32_t> vulnerableChips();

signals:
    void statusMessage(const QString& message);
    void exploitProgress(int step, int totalSteps);

private:
    // ── Exploit implementations ──────────────────────────────────────
    PblExploitResult exploitSaharaOverflow(const SaharaDeviceInfo& info);
    PblExploitResult exploitPeekPoke(const SaharaDeviceInfo& info);

    // ── Payload building ─────────────────────────────────────────────
    QByteArray buildOverflowPayload(uint32_t targetAddress, uint32_t payloadSize);
    QByteArray buildShellcode(uint64_t entryPoint);

    ITransport* m_transport = nullptr;

    // Known vulnerable PBL versions and their exploit parameters
    struct VulnInfo {
        uint32_t msmId;
        uint64_t overflowAddress;
        uint64_t stackAddress;
        uint32_t payloadMaxSize;
    };
    static const QList<VulnInfo>& vulnerabilityDb();
};

} // namespace sakura
