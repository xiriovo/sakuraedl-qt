#pragma once

#include "mediatek/exploit/brom_exploit_framework.h"

namespace sakura {

// ── Carbonara exploit ───────────────────────────────────────────────────────
//
// Uses the BROM's CMD_WRITE32 / CMD_READ32 commands as write/read primitives
// to patch security checks in SRAM before DA loading.
//
// Affected SoCs: MT6735, MT6737, MT6739, MT6750, MT6753, MT6755, MT6757,
//                MT6761, MT6763, MT6765, MT6768, MT6771, MT6779, MT6785, etc.
//
// Flow:
//   1. Use write32() to overwrite the SLA/DAA check return value in SRAM
//   2. Optionally dump BROM via read32() for analysis
//   3. Device now accepts unsigned DAs
//

class CarbonaraExploit : public IBromExploit {
    Q_OBJECT

public:
    explicit CarbonaraExploit(QObject* parent = nullptr);
    ~CarbonaraExploit() override;

    ExploitType exploitType() const override { return ExploitType::Carbonara; }
    QString name() const override { return QStringLiteral("Carbonara"); }
    bool isSupported(uint16_t hwCode) const override;

    ExploitResult execute(BromClient* brom, ITransport* transport,
                          const BromExploitTarget& target) override;

private:
    // Disable security checks by patching SRAM
    bool patchSecurityFlags(BromClient* brom, const BromExploitTarget& target);

    // Optional BROM dump for analysis
    QByteArray dumpBrom(BromClient* brom, const BromExploitTarget& target);

    // Supported HW codes for this exploit
    static const QList<uint16_t> s_supportedHwCodes;
};

} // namespace sakura
