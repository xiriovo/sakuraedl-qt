#pragma once

#include <QByteArray>
#include <QObject>
#include <QString>
#include <cstdint>

namespace sakura {

class ITransport;
class FdlClient;

// ── Spreadtrum exploit target info ──────────────────────────────────────────

struct SprdExploitTarget {
    uint16_t chipId = 0;
    QString  chipName;
    uint32_t sramBase = 0;
    uint32_t sramSize = 0;
    uint32_t payloadAddr = 0;
    uint32_t secCheckAddr = 0;     // Address of secure boot check
};

// ── Exploit result ──────────────────────────────────────────────────────────

struct SprdExploitResult {
    bool success = false;
    QString message;
    QByteArray dumpedData;         // Optional: dumped memory
};

// ── Spreadtrum exploit ──────────────────────────────────────────────────────
//
// Exploits the Spreadtrum BSL/BROM to bypass secure boot.
//
// Known techniques:
//   1. FDL checksum bypass — certain BSL versions don't validate the FDL
//      image properly, allowing unsigned code execution.
//   2. Memory corruption via crafted FDL headers — oversized length fields
//      can cause buffer overflows in the BSL.
//   3. Direct SRAM write via diagnostic commands.
//

class SprdExploit : public QObject {
    Q_OBJECT

public:
    explicit SprdExploit(QObject* parent = nullptr);
    ~SprdExploit() override;

    // Check if exploit is available for this chip
    bool isSupported(uint16_t chipId) const;

    // Execute exploit
    SprdExploitResult execute(FdlClient* fdl, ITransport* transport, uint16_t chipId);

    // Target database
    static SprdExploitTarget targetForChip(uint16_t chipId);

signals:
    void progressMessage(const QString& message);

private:
    // Exploit techniques
    SprdExploitResult tryChecksumBypass(FdlClient* fdl, ITransport* transport,
                                        const SprdExploitTarget& target);
    SprdExploitResult tryHeaderOverflow(FdlClient* fdl, ITransport* transport,
                                         const SprdExploitTarget& target);

    // Payload generation
    QByteArray buildPayload(const SprdExploitTarget& target);

    static const QList<uint16_t> s_supportedChips;
};

} // namespace sakura
